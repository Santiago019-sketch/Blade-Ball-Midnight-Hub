-- Midnight Hub Ultimate Edition
local version = '2.1 ULTIMATE'

-- Anti-Detection & Security
local function secure_load()
    local g = game:GetService("CoreGui")
    if g:FindFirstChild("Midnight_Host") then
        g:FindFirstChild("Midnight_Host"):Destroy()
    end
end
secure_load()

-- Core Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local Stats = game:GetService("Stats")
local CoreGui = game:GetService("CoreGui")

-- Variables
local local_player = Players.LocalPlayer or Players.PlayerAdded:Wait()
local camera = workspace.CurrentCamera
local closest_Entity = nil
local parry_remote = nil
local Balls = workspace:WaitForChild("Balls", 9e9)
local Remotes = ReplicatedStorage:WaitForChild("Remotes", 9e9)
local Debug = false

-- Configuration
getgenv().Settings = {
    -- Combat
    AutoParry = {
        Enabled = false,
        Distance = 12,
        Timing = 0.5,
        ShowRange = false,
        PingPrediction = true,
        AutoAdjust = true,
        SkillCheck = true,
        ReactionTime = 10
    },
    AutoBlock = {
        Enabled = false,
        HoldTime = 0.2
    },
    BallPrediction = {
        Enabled = false,
        ShowBeam = false,
        PredictedPosition = true
    },
    
    -- Visual
    Visuals = {
        CustomHitEffect = false,
        EffectID = "8632670510",
        CustomTrail = false,
        TrailID = "17483658369",
        KillEffect = false,
        BallESP = false,
        PlayerESP = false,
        Shaders = false
    },
    
    -- Performance
    Performance = {
        FPSBoost = false,
        AntiLag = false,
        OptimizeTextures = false
    },
    
    -- Misc
    Interface = {
        ToggleKey = Enum.KeyCode.RightShift,
        Rainbow = false,
        Watermark = true
    }
}

-- Load Essential Libraries
local OrionLib = loadstring(game:HttpGet(('https://raw.githubusercontent.com/shlexware/Orion/main/source')))()
local ESP = loadstring(game:HttpGet("https://kiriot22.com/releases/ESP.lua"))()

-- Utility Functions
local Utilities = {
    getBall = function()
        local balls = Balls:GetChildren()
        for i, v in pairs(balls) do
            if v:IsA("BasePart") and v:GetAttribute("realBall") == true then
                return v
            end
        end
        return nil
    end,
    
    getClosestPlayer = function()
        local closest = nil
        local maxDist = math.huge
        
        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= local_player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                local dist = (local_player.Character.HumanoidRootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude
                if dist < maxDist then
                    maxDist = dist
                    closest = plr
                end
            end
        end
        return closest
    end,
    
    createBeam = function(origin, destination)
        local beam = Instance.new("Beam")
        local a0 = Instance.new("Attachment")
        local a1 = Instance.new("Attachment")
        
        a0.Position = origin
        a1.Position = destination
        
        beam.Attachment0 = a0
        beam.Attachment1 = a1
        beam.Width0 = 0.5
        beam.Width1 = 0.5
        beam.FaceCamera = true
        
        return beam, a0, a1
    end,
    
    predictTrajectory = function(ball)
        local velocity = ball.Velocity
        local position = ball.Position
        local gravity = Vector3.new(0, -196.2, 0)
        
        local points = {}
        local step = 0.1
        
        for i = 0, 10, step do
            local point = position + velocity * i + 0.5 * gravity * i^2
            table.insert(points, point)
        end
        
        return points
    end
}

-- Create Window
local Window = OrionLib:MakeWindow({
    Name = "ðŸŒ™ Midnight Hub "..version,
    HidePremium = false,
    SaveConfig = true,
    ConfigFolder = "MidnightConfig",
    IntroEnabled = true,
    IntroText = "Midnight Hub Ultimate",
    IntroIcon = "rbxassetid://11348590078"
})

-- Create Tabs
local CombatTab = Window:MakeTab({Name = "Combat", Icon = "rbxassetid://4483345998"})
local VisualsTab = Window:MakeTab({Name = "Visuals", Icon = "rbxassetid://4483345998"})
local MiscTab = Window:MakeTab({Name = "Misc", Icon = "rbxassetid://4483345998"})
local SettingsTab = Window:MakeTab({Name = "Settings", Icon = "rbxassetid://4483345998"})

-- Combat Section
local AutoParrySection = CombatTab:AddSection({
    Name = "Auto Parry"
})

AutoParrySection:AddToggle({
    Name = "Enable Auto Parry",
    Default = false,
    Flag = "AutoParryEnabled",
    Save = true,
    Callback = function(Value)
        getgenv().Settings.AutoParry.Enabled = Value
    end    
})

AutoParrySection:AddSlider({
    Name = "Parry Distance",
    Min = 5,
    Max = 20,
    Default = 12,
    Color = Color3.fromRGB(255,255,255),
    Increment = 0.5,
    ValueName = "studs",
    Save = true,
    Callback = function(Value)
        getgenv().Settings.AutoParry.Distance = Value
    end    
})

AutoParrySection:AddToggle({
    Name = "Ping Prediction",
    Default = true,
    Save = true,
    Flag = "PingPrediction",
    Callback = function(Value)
        getgenv().Settings.AutoParry.PingPrediction = Value
    end    
})

-- Ball Prediction Section
local BallPredictionSection = CombatTab:AddSection({
    Name = "Ball Prediction"
})

BallPredictionSection:AddToggle({
    Name = "Show Prediction",
    Default = false,
    Save = true,
    Flag = "BallPrediction",
    Callback = function(Value)
        getgenv().Settings.BallPrediction.Enabled = Value
    end    
})

BallPredictionSection:AddToggle({
    Name = "Show Beam",
    Default = false,
    Save = true,
    Flag = "ShowBeam",
    Callback = function(Value)
        getgenv().Settings.BallPrediction.ShowBeam = Value
    end    
})

-- Visuals Section
local VisualsSection = VisualsTab:AddSection({
    Name = "Visual Effects"
})

VisualsSection:AddToggle({
    Name = "Custom Hit Effect",
    Default = false,
    Save = true,
    Flag = "CustomHitEffect",
    Callback = function(Value)
        getgenv().Settings.Visuals.CustomHitEffect = Value
    end    
})

VisualsSection:AddToggle({
    Name = "Ball ESP",
    Default = false,
    Save = true,
    Flag = "BallESP",
    Callback = function(Value)
        getgenv().Settings.Visuals.BallESP = Value
        if Value then
            ESP:Toggle(true)
            ESP.Ball = Value
        else
            ESP.Ball = false
        end
    end    
})

-- Enhanced Auto Parry System
local function InitializeAutoParry()
    local lastPositions = {}
    local lastUpdateTimes = {}
    
    local function VerifyBall(Ball)
        return typeof(Ball) == "Instance" 
            and Ball:IsA("BasePart") 
            and Ball:IsDescendantOf(Balls) 
            and Ball:GetAttribute("realBall") == true
    end
    
    local function IsTarget()
        return local_player.Character and local_player.Character:FindFirstChild("Highlight")
    end
    
    local function Parry()
        Remotes:WaitForChild("ParryButtonPress"):Fire()
    end
    
    Balls.ChildAdded:Connect(function(Ball)
        if not VerifyBall(Ball) then return end
        
        lastPositions[Ball] = Ball.Position
        lastUpdateTimes[Ball] = tick()
        
        Ball:GetPropertyChangedSignal("Position"):Connect(function()
            if not getgenv().Settings.AutoParry.Enabled then return end
            
            local currentTime = tick()
            local timeDelta = currentTime - lastUpdateTimes[Ball]
            
            if timeDelta < 1/60 then return end
            
            if IsTarget() then
                local distance = (Ball.Position - camera.Focus.Position).Magnitude
                local velocity = (lastPositions[Ball] - Ball.Position).Magnitude / timeDelta
                local timeToImpact = distance / velocity
                
                if timeToImpact <= getgenv().Settings.AutoParry.ReactionTime then
                    if getgenv().Settings.AutoParry.PingPrediction then
                        local ping = Stats.Network.ServerStatsItem["Data Ping"]:GetValue() / 1000
                        timeToImpact = timeToImpact - ping
                    end
                    
                    if timeToImpact > 0 then
                        Parry()
                    end
                end
            end
            
            lastPositions[Ball] = Ball.Position
            lastUpdateTimes[Ball] = currentTime
        end)
    end)
    
    Balls.ChildRemoved:Connect(function(Ball)
        lastPositions[Ball] = nil
        lastUpdateTimes[Ball] = nil
    end)
end

-- Initialize ESP
ESP:Toggle(true)
ESP.TeamColor = false
ESP.Names = true
ESP.Boxes = true
ESP.Tracers = false

-- Rainbow Theme
spawn(function()
    while true do
        if getgenv().Settings.Interface.Rainbow then
            local hue = tick() % 5 / 5
            local color = Color3.fromHSV(hue, 1, 1)
            OrionLib:ChangeTheme("TextColor", color)
        end
        wait(0.1)
    end
end)

-- Initialize Core Systems
local function Initialize()
    InitializeAutoParry()
    
    -- Hit Effect System
    ReplicatedStorage.Remotes.ParrySuccess.OnClientEvent:Connect(function()
        if getgenv().Settings.Visuals.CustomHitEffect then
            local hit_effect = Instance.new("ParticleEmitter")
            hit_effect.Texture = "rbxassetid://" .. getgenv().Settings.Visuals.EffectID
            hit_effect.Parent = Utilities.getBall()
            hit_effect:Emit(5)
            
            task.delay(1, function()
                hit_effect:Destroy()
            end)
        end
    end)
    
    -- Ball Prediction System
    RunService.RenderStepped:Connect(function()
        if getgenv().Settings.BallPrediction.Enabled then
            local ball = Utilities.getBall()
            if ball then
                local trajectory = Utilities.predictTrajectory(ball)
                
                if getgenv().Settings.BallPrediction.ShowBeam then
                    for i = 1, #trajectory-1 do
                        local beam, a0, a1 = Utilities.createBeam(trajectory[i], trajectory[i+1])
                        task.delay(0.1, function()
                            beam:Destroy()
                            a0:Destroy()
                            a1:Destroy()
                        end)
                    end
                end
            end
        end
    end)
end

-- Start Everything
Initialize()
OrionLib:Init()

-- Notification
OrionLib:MakeNotification({
    Name = "Midnight Hub Ultimate",
    Content = "Successfully loaded! Press RightShift to toggle UI",
    Image = "rbxassetid://4483345998",
    Time = 5
})
