-- Midnight Hub Ultimate Edition
local version = '2.0 ULTIMATE'

-- Anti-Detection & Security
local function secure_load()
    local g = game:GetService("CoreGui")
    if g:FindFirstChild("Midnight_Host") then
        g:FindFirstChild("Midnight_Host"):Destroy()
    end
end
secure_load()

-- Core Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local Stats = game:GetService("Stats")
local CoreGui = game:GetService("CoreGui")

-- Variables
local local_player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local closest_Entity = nil
local parry_remote = nil
local Balls = workspace:WaitForChild("Balls", 9e9)

-- Configuration
getgenv().Settings = {
    -- Combat
    AutoParry = {
        Enabled = false,
        Distance = 12,
        Timing = 0.5,
        ShowRange = false,
        PingPrediction = true,
        AutoAdjust = true,
        SkillCheck = true
    },
    AutoBlock = {
        Enabled = false,
        HoldTime = 0.2
    },
    BallPrediction = {
        Enabled = false,
        ShowBeam = false,
        PredictedPosition = true
    },
    
    -- Visual
    Visuals = {
        CustomHitEffect = false,
        EffectID = "8632670510",
        CustomTrail = false,
        TrailID = "17483658369",
        KillEffect = false,
        BallESP = false,
        PlayerESP = false,
        Shaders = false
    },
    
    -- Performance
    Performance = {
        FPSBoost = false,
        AntiLag = false,
        OptimizeTextures = false
    },
    
    -- Misc
    Interface = {
        ToggleKey = Enum.KeyCode.RightShift,
        Rainbow = false,
        Watermark = true
    }
}

-- Load Essential Libraries
local OrionLib = loadstring(game:HttpGet(('https://raw.githubusercontent.com/shlexware/Orion/main/source')))()
local ESP = loadstring(game:HttpGet("https://kiriot22.com/releases/ESP.lua"))()

-- Create Window
local Window = OrionLib:MakeWindow({
    Name = "ðŸŒ™ Midnight Hub "..version,
    HidePremium = false,
    SaveConfig = true,
    ConfigFolder = "MidnightConfig",
    IntroEnabled = true,
    IntroText = "Midnight Hub Ultimate",
    IntroIcon = "rbxassetid://11348590078"
})

-- Utility Functions
local Utilities = {
    getBall = function()
        local balls = workspace:WaitForChild("Balls", 9e9):GetChildren()
        for i, v in pairs(balls) do
            if v:IsA("BasePart") and v:GetAttribute("realBall") == true then
                return v
            end
        end
        return nil
    end,
    
    getClosestPlayer = function()
        local closest = nil
        local maxDist = math.huge
        
        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= local_player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                local dist = (local_player.Character.HumanoidRootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude
                if dist < maxDist then
                    maxDist = dist
                    closest = plr
                end
            end
        end
        return closest
    end,
    
    createBeam = function(origin, destination)
        local beam = Instance.new("Beam")
        local a0 = Instance.new("Attachment")
        local a1 = Instance.new("Attachment")
        
        a0.Position = origin
        a1.Position = destination
        
        beam.Attachment0 = a0
        beam.Attachment1 = a1
        beam.Width0 = 0.5
        beam.Width1 = 0.5
        beam.FaceCamera = true
        
        return beam, a0, a1
    end,
    
    predictTrajectory = function(ball)
        local velocity = ball.Velocity
        local position = ball.Position
        local gravity = Vector3.new(0, -196.2, 0)
        
        local points = {}
        local step = 0.1
        
        for i = 0, 10, step do
            local point = position + velocity * i + 0.5 * gravity * i^2
            table.insert(points, point)
        end
        
        return points
    end
}

-- Create Tabs
local CombatTab = Window:MakeTab({Name = "Combat", Icon = "rbxassetid://4483345998"})
local VisualsTab = Window:MakeTab({Name = "Visuals", Icon = "rbxassetid://4483345998"})
local MiscTab = Window:MakeTab({Name = "Misc", Icon = "rbxassetid://4483345998"})
local SettingsTab = Window:MakeTab({Name = "Settings", Icon = "rbxassetid://4483345998"})

-- Combat Section
local AutoParrySection = CombatTab:AddSection({
    Name = "Auto Parry"
})

AutoParrySection:AddToggle({
    Name = "Enable Auto Parry",
    Default = false,
    Flag = "AutoParryEnabled",
    Save = true,
    Callback = function(Value)
        getgenv().Settings.AutoParry.Enabled = Value
    end    
})

AutoParrySection:AddSlider({
    Name = "Parry Distance",
    Min = 5,
    Max = 20,
    Default = 12,
    Color = Color3.fromRGB(255,255,255),
    Increment = 0.5,
    ValueName = "studs",
    Save = true,
    Callback = function(Value)
        getgenv().Settings.AutoParry.Distance = Value
    end    
})

AutoParrySection:AddToggle({
    Name = "Ping Prediction",
    Default = true,
    Save = true,
    Flag = "PingPrediction",
    Callback = function(Value)
        getgenv().Settings.AutoParry.PingPrediction = Value
    end    
})

-- Visuals Section
local VisualsSection = VisualsTab:AddSection({
    Name = "Visual Effects"
})

VisualsSection:AddToggle({
    Name = "Custom Hit Effect",
    Default = false,
    Save = true,
    Flag = "CustomHitEffect",
    Callback = function(Value)
        getgenv().Settings.Visuals.CustomHitEffect = Value
    end    
})

VisualsSection:AddToggle({
    Name = "Ball ESP",
    Default = false,
    Save = true,
    Flag = "BallESP",
    Callback = function(Value)
        getgenv().Settings.Visuals.BallESP = Value
        
        if Value then
            ESP:Toggle(true)
            ESP.Ball = Value
        else
            ESP.Ball = false
        end
    end    
})

VisualsSection:AddToggle({
    Name = "Player ESP",
    Default = false,
    Save = true,
    Flag = "PlayerESP",
    Callback = function(Value)
        getgenv().Settings.Visuals.PlayerESP = Value
        
        if Value then
            ESP:Toggle(true)
            ESP.Players = Value
        else
            ESP.Players = false
        end
    end    
})

VisualsSection:AddToggle({
    Name = "Kill Effect",
    Default = false,
    Save = true,
    Flag = "KillEffect",
    Callback = function(Value)
        getgenv().Settings.Visuals.KillEffect = Value
    end    
})

-- Misc Section
local MiscSection = MiscTab:AddSection({
    Name = "Performance"
})

MiscSection:AddToggle({
    Name = "FPS Boost",
    Default = false,
    Save = true,
    Flag = "FPSBoost",
    Callback = function(Value)
        getgenv().Settings.Performance.FPSBoost = Value
        if Value then
            loadstring(game:HttpGet("https://pastebin.com/raw/uzLqqbec"))()
        end
    end    
})

MiscSection:AddToggle({
    Name = "Anti Lag",
    Default = false,
    Save = true,
    Flag = "AntiLag",
    Callback = function(Value)
        getgenv().Settings.Performance.AntiLag = Value
        if Value then
            loadstring(game:HttpGet("https://pastebin.com/raw/qtu4MBV0"))()
        end
    end    
})

-- Settings Section
local SettingsSection = SettingsTab:AddSection({
    Name = "Interface Settings"
})

SettingsSection:AddBind({
    Name = "Toggle UI",
    Default = Enum.KeyCode.RightShift,
    Hold = false,
    Flag = "ToggleUI",
    Save = true,
    Callback = function()
        OrionLib:ToggleUI()
    end    
})

SettingsSection:AddToggle({
    Name = "Rainbow Theme",
    Default = false,
    Flag = "RainbowTheme",
    Save = true,
    Callback = function(Value)
        getgenv().Settings.Interface.Rainbow = Value
    end    
})

-- Initialize Core Systems
local function initializeCore()
    -- Hit Effect System
    ReplicatedStorage.Remotes.ParrySuccess.OnClientEvent:Connect(function()
        if getgenv().Settings.Visuals.CustomHitEffect then
            local hit_effect = Instance.new("ParticleEmitter")
            hit_effect.Texture = "rbxassetid://" .. getgenv().Settings.Visuals.EffectID
            hit_effect.Parent = Utilities.getBall()
            hit_effect:Emit(5)
            
            task.delay(1, function()
                hit_effect:Destroy()
            end)
        end
    end)
    
    -- Ball Prediction System
    RunService.RenderStepped:Connect(function()
        if getgenv().Settings.BallPrediction.Enabled then
            local ball = Utilities.getBall()
            if ball then
                local trajectory = Utilities.predictTrajectory(ball)
                
                if getgenv().Settings.BallPrediction.ShowBeam then
                    for i = 1, #trajectory-1 do
                        local beam, a0, a1 = Utilities.createBeam(trajectory[i], trajectory[i+1])
                        task.delay(0.1, function()
                            beam:Destroy()
                            a0:Destroy()
                            a1:Destroy()
                        end)
                    end
                end
            end
        end
    end)
    
    -- Auto Parry Core
    RunService.Heartbeat:Connect(function()
        if getgenv().Settings.AutoParry.Enabled then
            local ball = Utilities.getBall()
            if ball then
                local distance = (ball.Position - local_player.Character.HumanoidRootPart.Position).Magnitude
                local ping = Stats.Network.ServerStatsItem["Data Ping"]:GetValue()
                local predictionOffset = getgenv().Settings.AutoParry.PingPrediction and (ping/1000) or 0
                
                if distance <= getgenv().Settings.AutoParry.Distance then
                    local velocity = ball.Velocity
                    local direction = (local_player.Character.HumanoidRootPart.Position - ball.Position).Unit
                    
                    if velocity.Magnitude > 0 and direction:Dot(velocity.Unit) > 0 then
                        game:GetService("ReplicatedStorage").Remotes.ParryButtonPress:Fire()
                    end
                end
            end
        end
    end)
end

-- Initialize ESP
ESP:Toggle(true)
ESP.TeamColor = false
ESP.Names = true
ESP.Boxes = true
ESP.Tracers = false

-- Rainbow Theme
spawn(function()
    while true do
        if getgenv().Settings.Interface.Rainbow then
            local hue = tick() % 5 / 5
            local color = Color3.fromHSV(hue, 1, 1)
            OrionLib:ChangeTheme("TextColor", color)
        end
        wait(0.1)
    end
end)

-- Initialize
initializeCore()
OrionLib:Init()

-- Notification
OrionLib:MakeNotification({
    Name = "Midnight Hub Ultimate",
    Content = "Successfully loaded! Press RightShift to toggle UI",
    Image = "rbxassetid://4483345998",
    Time = 5
})
