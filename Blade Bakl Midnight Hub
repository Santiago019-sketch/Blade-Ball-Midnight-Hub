-- Midnight Hub Ultimate Edition
local version = '2.3 ULTIMATE'

-- Core Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local Stats = game:GetService("Stats")
local CoreGui = game:GetService("CoreGui")

-- Variables
local local_player = Players.LocalPlayer or Players.PlayerAdded:Wait()
local camera = workspace.CurrentCamera
local Balls = workspace:WaitForChild("Balls", 9e9)

-- Configuration
getgenv().Settings = {
    -- Combat
    AutoParry = {
        Enabled = false,
        Distance = 12,
        Timing = 10, -- Time threshold for parrying (in distance/velocity units)
        UseMouseClick = true, -- New setting to toggle between mouse click and remote
        ShowRange = false,
        PingBased = true,
        PingBasedOffset = 0
    },
    AutoBlock = {
        Enabled = false,
        HoldTime = 0.2
    },
    BallPrediction = {
        Enabled = false,
        ShowBeam = false,
        PredictedPosition = true
    },
    
    -- Visual
    Visuals = {
        CustomHitEffect = false,
        EffectID = "8632670510",
        CustomTrail = false,
        TrailID = "17483658369",
        KillEffect = false,
        BallESP = false,
        PlayerESP = false,
        Shaders = false
    },
    
    -- Performance & Misc settings remain the same as before
}

-- Utility Functions
local Utilities = {
    VerifyBall = function(Ball)
        if typeof(Ball) == "Instance" and Ball:IsA("BasePart") and Ball:IsDescendantOf(Balls) and Ball:GetAttribute("realBall") == true then
            return true
        end
        return false
    end,
    
    IsTarget = function()
        return (local_player.Character and local_player.Character:FindFirstChild("Highlight"))
    end,
    
    Parry = function()
        if getgenv().Settings.AutoParry.UseMouseClick then
            -- Simulate mouse click
            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        else
            -- Use remote
            ReplicatedStorage:WaitForChild("Remotes").ParryButtonPress:Fire()
        end
    end
}

-- Enhanced Auto Parry System
local function InitializeEnhancedAutoParry()
    Balls.ChildAdded:Connect(function(Ball)
        if not Utilities.VerifyBall(Ball) then
            return
        end
        
        local OldPosition = Ball.Position
        local OldTick = tick()
        
        Ball:GetPropertyChangedSignal("Position"):Connect(function()
            if not getgenv().Settings.AutoParry.Enabled then return end
            
            if Utilities.IsTarget() then
                local Distance = (Ball.Position - workspace.CurrentCamera.Focus.Position).Magnitude
                local Velocity = (OldPosition - Ball.Position).Magnitude
                
                if getgenv().Settings.AutoParry.PingBased then
                    local Ping = game.Stats.Network.ServerStatsItem["Data Ping"]:GetValue() / 1000
                    Distance = Distance - (Velocity * Ping) - getgenv().Settings.AutoParry.PingBasedOffset
                end
                
                if (Distance / Velocity) <= getgenv().Settings.AutoParry.Timing then
                    Utilities.Parry()
                end
            end
            
            -- Update position tracking (frame rate limited)
            if (tick() - OldTick >= 1/60) then
                OldTick = tick()
                OldPosition = Ball.Position
            end
        end)
    end)
end

-- Create UI Window and Tabs (keeping the same structure as before)
local OrionLib = loadstring(game:HttpGet(('https://raw.githubusercontent.com/shlexware/Orion/main/source')))()
local Window = OrionLib:MakeWindow({
    Name = "ðŸŒ™ Midnight Hub "..version,
    HidePremium = false,
    SaveConfig = true,
    ConfigFolder = "MidnightConfig",
    IntroEnabled = true,
    IntroText = "Midnight Hub Ultimate",
    IntroIcon = "rbxassetid://11348590078"
})

-- Create Tabs
local CombatTab = Window:MakeTab({Name = "Combat", Icon = "rbxassetid://4483345998"})
local VisualsTab = Window:MakeTab({Name = "Visuals", Icon = "rbxassetid://4483345998"})
local MiscTab = Window:MakeTab({Name = "Misc", Icon = "rbxassetid://4483345998"})
local SettingsTab = Window:MakeTab({Name = "Settings", Icon = "rbxassetid://4483345998"})

-- Enhanced Combat Section
local AutoParrySection = CombatTab:AddSection({
    Name = "Auto Parry"
})

AutoParrySection:AddToggle({
    Name = "Enable Auto Parry",
    Default = false,
    Flag = "AutoParryEnabled",
    Save = true,
    Callback = function(Value)
        getgenv().Settings.AutoParry.Enabled = Value
    end    
})

AutoParrySection:AddToggle({
    Name = "Use Mouse Click",
    Default = true,
    Flag = "UseMouseClick",
    Save = true,
    Callback = function(Value)
        getgenv().Settings.AutoParry.UseMouseClick = Value
    end    
})

AutoParrySection:AddToggle({
    Name = "Ping Based",
    Default = true,
    Flag = "PingBased",
    Save = true,
    Callback = function(Value)
        getgenv().Settings.AutoParry.PingBased = Value
    end    
})

AutoParrySection:AddSlider({
    Name = "Parry Timing",
    Min = 5,
    Max = 15,
    Default = 10,
    Color = Color3.fromRGB(255,255,255),
    Increment = 0.5,
    ValueName = "threshold",
    Save = true,
    Callback = function(Value)
        getgenv().Settings.AutoParry.Timing = Value
    end    
})

AutoParrySection:AddSlider({
    Name = "Ping Offset",
    Min = -2,
    Max = 2,
    Default = 0,
    Increment = 0.1,
    Flag = "PingOffset",
    Save = true,
    Callback = function(Value)
        getgenv().Settings.AutoParry.PingBasedOffset = Value
    end
})

-- Initialize Core Systems
local function Initialize()
    InitializeEnhancedAutoParry()
    
    -- ESP Initialization
    local ESP = loadstring(game:HttpGet("https://kiriot22.com/releases/ESP.lua"))()
    ESP:Toggle(true)
    ESP.TeamColor = false
    ESP.Names = true
    ESP.Boxes = true
    ESP.Tracers = false
    
    -- Anti-Detection
    local function secure_load()
        local g = game:GetService("CoreGui")
        if g:FindFirstChild("Midnight_Host") then
            g:FindFirstChild("Midnight_Host"):Destroy()
        end
    end
    secure_load()
end

-- Start Everything
Initialize()
OrionLib:Init()

-- Notification
OrionLib:MakeNotification({
    Name = "Midnight Hub Ultimate",
    Content = "Successfully loaded with enhanced auto-parry! Press RightShift to toggle UI",
    Image = "rbxassetid://4483345998",
    Time = 5
})
